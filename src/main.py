import asyncio
from pathlib import Path
import json
from datetime import datetime

from src.processors.content_processor import ContentProcessor
from src.utils.logger import log
from src.config import settings

async def main(event_description: str):
    """
    主程序入口
    
    Args:
        event_description: 事件描述文本
    """
    processor = ContentProcessor()
    
    try:
        # 处理事件并获取结果
        results = await processor.process_event(event_description)
        
        # 保存处理结果
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        result_file = settings.TODAY_LOGS_DIR / f"result_{timestamp}.json"
        
        with open(result_file, "w", encoding="utf-8") as f:
            json.dump(results, f, ensure_ascii=False, indent=2)
            
        log.info(f"结果已保存到: {result_file}")
        return results
        
    except Exception as e:
        log.error(f"处理失败: {str(e)}")
        raise

if __name__ == "__main__":
    # 示例使用
    event_description = """近日，《深圳市住房和建设局关于规范我市转租和受托经营房屋租赁行为的通知》发布。《通知》内容主要针对当前深圳住房租赁市场存在的“二房东”以及租赁企业备案，虚假租赁房源信息，转租行为以及房东随意克扣租金、乱收水电费等问题予以规范和明确，旨在进一步规范深圳租赁市场租赁行为，确保深圳租赁市场能实现公平、透明和有序的发展，切实保障租赁双方的合法权益。
　　所谓“二房东”，是指承租人将租赁的物业再次分割对外出租，以赚取租金差价的机构或个人，分为传统型二房东和专业运营机构。前者往往游离于监管之外，给很多租客留下了不愉快的经验。
　　以深圳而论，高租金的背后，除了深圳不断增加的人口流入与住房供给之间的供需矛盾之外，近些年大规模出现的“二房东”现象也成了一个很大的推手。
　　不但推高租房价格，还可能在水电费上藏猫腻，更严重的是，“二房东”现象中还隐藏着安全风险。
　　前不久，上海高院微信公众号公布了一起案例:“二房东”租下某小区90多平米的两室两厅房屋，为了摊薄租用成本，将房屋分隔后又转租给多人，使房屋内共居住了10人。“二房东”明知租客经常将电动车带回室内充电，未有效劝阻，最终因电瓶充电导致发生火灾，造成了2人当场死亡、1人受伤的严重后果……
　　人们对“二房东”怨声载道，但是也必须承认，“二房东”是市场自然生长出来的群体，当房屋租赁市场的体量达到一定规模后，“二房东”现象很难杜绝。实际上，机构化的“二房东”也有运作不错的案例。
　　因此，针对“二房东”现象，与其深恶痛绝，不如说当下真正需要的是规范。
　　推进租购同权，规范住房租赁市场，让更多涌入城市逐梦的“新市民”安居，需要法治保障。在这方面，我国《民法典》《商品房屋租赁管理办法》等原本都有一些规定，但比较原则和笼统，特别是围绕规制“二房东”缺乏清晰界定，导致操作性不强。
　　此次深圳出台“新规”，有利于平衡租赁双方权利义务关系，尤其是对“二房东”自然人做出了明确规范要求，显然具有重要意义。
　　政策明确针对租赁市场常见的“二房东”，即转租“住房数量达到十套(间)及以上的自然人，应当依法办理商事登记，取得营业执照，明确房屋租赁企业(含办理商事登记的自然人)，须在规定时间内，通过深圳市住房租赁监管服务平台办理备案。与此同时，政策要求房屋租赁企业(含办理商事登记的自然人)应按规定与银行设立住房租赁资金监管账户。
　　一言以蔽之，当一个“二房东”手里有了一定数量的房源之后，就需要参照机构化模式进行管理。长期以来，二房东游离于监管之外，有关部门缺乏监管抓手的问题，至此获得了解决。
　　新规要求严控最小出租单位，防止改造“房中房”，同样很有针对性。
　　帮助新市民更好更快地融入城市，深圳的房屋租赁新规开了好头。接下来，如何执行是关键。
　　2022年，上海出台了禁止群租的法规，但今年有媒体报道，某上海房东举报自家房子20㎡住9人，城管开罚单后“二房东”却让房东承担，房东再找城管，城管则称按照政策，本部门没有强制权，对此只能劝说。这里暴露的是部门联合执法协同不够，从而导致政策威慑力不足的问题。深圳实施新规需要引以为鉴。
　　另外，众所周知，引导合规，总会产生一定的成本。新产生的成本能否确保不转嫁给租客，相信也是公众的期待。"""
    
    asyncio.run(main(event_description)) 